---
title: "Data Preparation"
author: "Derek Castleman"
date: "9/1/2021"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

In this notebook I will take the various excel files that were collected at the civil rights website. I will use Tidyverse to fix the data tables changing rows into columns and renaming columns. After this I will join them with the data from the census bureau on poverty. I will use the proportion of students in the district to create proportions for the different characteristics of the school districts. I will use inner joins on some of the datatables since I want the districts that have these features represented and left join on others (like sports) which have some districts that do not have any of these and I do not want to lose them.

```{r}
library(tidyverse)
```

Reading in Chronic Absent File and then taking a look at the data afterwards.

```{r}
chronic_absent <- read_csv("cummalitiveabsent.csv")
chronic_absent
```

Grouping the schools together.

```{r}
chronic_absent_group <- group_by(chronic_absent, LEA, ID)
chronic_absent_group
```

Collapse the chronic absent data down to just one total for the entire school district.

```{r}
final_chronic_absent_data <- summarise(chronic_absent_group, Total_Absent = sum(Total))
final_chronic_absent_data
```

Reading in the suspension data and taking a look at it.

```{r}
suspension_data <- read_csv('cummalativesuspension.csv')
suspension_data
```

Grouping districts then summarizing the two genders for each district down to one total number.

```{r}
final_suspension_data <- suspension_data %>% group_by(LEA, ID) %>%
  summarise(Total_Suspended = sum(Total))
final_suspension_data
```

```{r}
sum(is.na(final_suspension_data))
```


Reading in the AP test data then taking a look at what it has.

```{r}
ap_data <- read_csv('cummalativeap.csv')
ap_data
```

Going to pivot the table so that each category becomes its own separate column and rename the columns to shorter names

```{r}
ap_fixed <- ap_data %>% pivot_wider(names_from = Category, values_from = Total) %>%
  rename(
    AP_Enrollment = 'Enrollment in AP classes',
    AP_Test_Takers = 'Taking AP tests for some AP courses taken'
  )
ap_fixed
```

Creating a final column with proportion of those enrolled in ap courses that took the test.

```{r}
ap_new_column <- mutate(ap_fixed, Takers_Proportion = AP_Test_Takers / AP_Enrollment)
ap_new_column
```

Have to fix the NaN columns to a 0 since that is what they should actually be.

```{r}
final_ap <- replace(ap_new_column, is.na(ap_new_column), 0)
final_ap
```

Load the testing data and then take a look at it.

```{r}
testing_data <- read_csv('cummalativetesting.csv')
testing_data
```

Make sure that the districts are all grouped together then summarize the testing data down to one value to get rid of the genders.

```{r}
final_testing <- testing_data %>% group_by(LEA, ID) %>%
  summarise(Total_Test = sum(Total))
final_testing
```

Loading in the teaching data then looking at it to see the layout.

```{r}
teaching_data <- read_csv('cummalativeteachingfixed.csv')
teaching_data
```

Pivot the table for the categories to be turned into columns.

```{r}
teaching_fixed <- teaching_data %>% pivot_wider(names_from = Category, values_from = Total) %>%
  rename(
    Total_Teachers = 'Classroom Teachers',
    First_Year = 'Classroom teachers in their first year of teaching',
    Second_Year = 'Classroom teachers in their second year of teaching',
    Chronic_Absent_Teachers = 'Teachers absent more than 10 days of the school year',
    Counselors = 'High-School Counselors'
  )
teaching_fixed
```

Create columns with proportion of new teachers (ones in their first and second year) and proportion of teachers chronically absent. Then removing any districts with an NaN because this would mean they have no teachers (yes I found that one district had 0 teachers).

```{r}
final_teaching <- mutate(teaching_fixed, New_Teachers_Proportion = (First_Year + Second_Year) / Total_Teachers, Absent_Teacher_Proportion = Chronic_Absent_Teachers / Total_Teachers)
final_teaching <- na.omit(final_teaching)
final_teaching
```

Loading in the data for sports and then taking a look at what is present.

```{r}
sports_data <- read_csv('cummalativesports.csv')
sports_data
```

I am going to pivot the categories to make columns for each one and then rename them.

```{r}
final_sports <- sports_data %>% pivot_wider(names_from = Category, values_from = Total) %>%
  rename(
    Teams = 'Single-sex teams',
    Athletes = 'Participants on single-sex teams'
  )
final_sports
```

Importing the data for the student population and the number in poverty for that district.

```{r}
poverty_data <- read_csv('povertylevelfixed.csv')
poverty_data
```

I need to combine the State Code with the ID because that is how it is represented in all of the other datatables that I have worked with so far. I learned how to do this from <https://stackoverflow.com/questions/24248029/how-to-concatenate-numeric-columns-in-r> by user sbha at the bottom of the page.

```{r}
fixed_poverty_data <- poverty_data %>%
  mutate(fixed_ID = paste0(State, ID))
fixed_poverty_data
```

I am going to fix the table by deleting the columns for State and ID, renaming the fixed_Id so it matches the other databables and then shifting its position to the front. I will also create a new column that is the proportion of students that are living in poverty within the school district (this will be the target for the machine learning model that will be developed).

```{r}
final_poverty_table <- fixed_poverty_data %>%
  select(-State, -ID) %>%
  rename(ID = fixed_ID) %>%
  select(ID, everything()) %>%
  mutate(Poverty_Proportion = Children_Poverty / District_Population, Student_Prop = District_Population / Area_Population) %>%
  select(-District_Population)
final_poverty_table
```

```{r}
demo_data <- read_csv('cummalativedemo.csv')
demo_data
```
```{r}
final_demo_table <- demo_data %>%
  mutate(Non_White_Students = (District_Population - White) / District_Population) %>%
  select(-White)
final_demo_table
```


I am going to do an inner join with the poverty table and the demographics table. I am doing an inner join so that I can keep the districts that we have demographics data for and get rid of the districts where it does not exist. I am going to join on the ID because this is the distinct common feature that they should share in common. I learned how to do this from: <https://dplyr.tidyverse.org/reference/join.html>

```{r}
combined_demo_poverty <- inner_join(final_poverty_table, final_demo_table, by = 'ID')
combined_demo_poverty
```


I am going to combined the new datatable with the teacher one with an inner join since I only want districts where we have teaching data for.


```{r}
combined_poverty_teacher <- inner_join(combined_demo_poverty, final_teaching, by = 'ID')
combined_poverty_teacher
```

Create two new columns. One of them will be the number of counselors per each student using the student population and counselors data then the number of teachers per a student by using the total teachers and the student population.

```{r}
combined_teacher_new_data <- mutate(combined_poverty_teacher, Counselor_Ratio = Counselors / District_Population, Student_Teacher_Ratio = District_Population / Total_Teachers)
combined_teacher_new_data
```

I am going to remove the columns that are listed twice from the inner join as well as some of the columns no longer needed as I move forward (number of teachers, counselors, etc.)

```{r}
final_teacher_combined <- select(combined_teacher_new_data, -'Lea State.y', -LEA.y, -Total_Teachers, -First_Year, -Second_Year, -Chronic_Absent_Teachers, -Counselors)
final_teacher_combined
```

Combine chronic abseentism with the data table using an inner join of ID once again.Have to change ID to string first from the absent one so that they can be combined.

```{r}
class(final_chronic_absent_data$ID) = "character"
combined_with_abseentism <- inner_join(final_teacher_combined, final_chronic_absent_data, by = 'ID')
combined_with_abseentism
```

Going to create a new column with proportion of chronic abseentism based off the student population then I am going to drop the LEA and Total_Absent column since it will no longer be needed.

```{r}
final_absent_combined <- combined_with_abseentism %>%
  mutate(Absent_Prop = Total_Absent / District_Population) %>%
  select(-LEA, -Total_Absent)
final_absent_combined
```

I am going to do another inner join with the testing data to combine with this datatable.

```{r}
combined_with_testing <- inner_join(final_absent_combined, final_testing, by = 'ID')
combined_with_testing
```

Going to create a new column with proportion of test takers based off the student population then I am going to drop the LEA and Total_Test since it will no longer be needed.

```{r}
final_test_combined <- combined_with_testing %>%
  mutate(Test_Prop = Total_Test / District_Population) %>%
  select(-LEA, -Total_Test)
final_test_combined
```

I am going to combine the sports data with the other combined data. This time I am going to do a left join since I know that some districts do not have sports and I do not want to lose those. Have to change the ID of the sports to character to allow for it to be combined.

```{r}
class(final_sports$ID) = "character"
combined_with_sports <- left_join(final_test_combined, final_sports, by = 'ID')
combined_with_sports
```

Turn the NA values into 0 because these are districts that do not have any sports so their true value should be 0. I can only do this for the numeric columns. I found out how to do this from: <https://stackoverflow.com/questions/19379081/how-to-replace-na-values-in-a-table-for-selected-columns> especially from user sbha once again.

```{r}
fixed_combined_sports <- combined_with_sports %>%
  mutate_if(is.numeric, ~replace_na(., 0))
fixed_combined_sports
```

I will turn the teams and athletes columns into a proportion based off the student population and then I will drop the columns that are no longer needed.

```{r}
final_sports_combined <- fixed_combined_sports %>%
  mutate(Teams_Prop = Teams / District_Population, Athletes_Prop = Athletes / District_Population) %>%
  select(-'Lea State', -LEA, -Teams, -Athletes)
final_sports_combined
```

I am going to join the AP test data with the datatable but I will be using a left join once again since there could be some districts that are not represented due to not having any AP courses at all.

```{r}
class(final_ap$ID) = "character"
combined_with_ap <- left_join(final_sports_combined, final_ap, by = 'ID')
combined_with_ap
```

Checking to see how many missing values for AP might exist.

```{r}
sum(is.na(combined_with_ap))
```

I am going to insert the value of 0 in for any of the number columns that are missing AP courses. Then I will create a new column that has the proportion of students taking AP courses within the district. Then drop the columns that are no longer needed.

```{r}
final_ap_combined <- combined_with_ap %>%
  mutate_if(is.numeric, ~replace_na(., 0)) %>%
  mutate(AP_Prop = AP_Enrollment /District_Population) %>% 
  select(-'Lea State', -LEA, -AP_Enrollment, -AP_Test_Takers)
final_ap_combined
```

Combine suspension data in with the other datatable. Going to use a left join once again in case there is any data missing.

```{r}
combined_with_suspension <- left_join(final_ap_combined, final_suspension_data, by = 'ID')
combined_with_suspension
```

Check if there are any values that are null in the datatable.

```{r}
sum(is.na(combined_with_suspension))
```

These are total days suspended so I will keep the category the way that it is. I will just drop the excess category that is no longer needed.

```{r}
final_susp_combined <- combined_with_suspension %>%
  select(-LEA)
final_susp_combined
```

I am going to load the total suspension counts to create an average with the days suspended.

```{r}
suspension_data_total <- read_csv('cummalativesuspensioncount.csv')
suspension_data_total
```

I am going to combine the total suspend count with the other datatable. I am going to do a left join because the website where I gathered data is having issues and the region that represents Chicago is having errors that will not allow for the data to be gathered.

```{r}
combined_with_suspension_count <- left_join(combined_with_suspension, suspension_data_total, by = 'ID')
combined_with_suspension_count
```

CHecking how many missing values I have now that it has been combined with Chicago region missing.

```{r}
sum(is.na(combined_with_suspension_count))
```

I am going to replace the missing values from Chicago with the mean values for the column to deal with the issue of not being able to obtain the data. I learned how to do this method from: <https://www.tutorialspoint.com/how-to-replace-na-values-in-columns-of-an-r-data-frame-form-the-mean-of-that-column>

```{r}
combined_with_suspension_count$Total_Suspension[is.na(combined_with_suspension_count$Total_Suspension)]<-mean(combined_with_suspension_count$Total_Suspension,na.rm=TRUE)
combined_with_suspension_count
```

Checking if any missing values still remain.

```{r}
sum(is.na(combined_with_suspension_count))
```

Going to create a new column that creates the average days of suspension by taking the number of days suspended divided by the suspension count. This will allow for better comparison between districts of different sizes. Then I will drop the columns that are no longer needed.

```{r}
final_with_suspension_count <- combined_with_suspension_count %>% 
  mutate(AVG_Suspenion = Total_Suspension / District_Population) %>%
  select(-LEA, -Total_Suspended, -Total_Suspension)
final_with_suspension_count
```

Loading the discipline data and then taking a look at it.

```{r}
discipline_data <- read_csv('cummalativediscpline.csv')
discipline_data
```

Going to pivot the table wider to turn the categories into columns. Then change the name of the columns.

```{r}
discipline_fixed <- discipline_data %>% pivot_wider(names_from = Category, values_from = Total) %>%
  rename(
    Expulsions = 'Expulsions with educational services',
    Police_Involvement = 'Referral to law enforcement'
  )
discipline_fixed
```

Going to do an left join with the other datatable since the Chicago districts are missing from the data.

```{r}
combined_with_discipline <- left_join(final_with_suspension_count, discipline_fixed, by = 'ID')
combined_with_discipline
```

Checking for how many na data there is.

```{r}
sum(is.na(combined_with_discipline))
```

Going to drop the few rows that are missing values for this.

```{r}
combined_with_discipline <- drop_na(combined_with_discipline)
combined_with_discipline
```

Checking the missing value count again.

```{r}
sum(is.na(combined_with_discipline))
```

Create new columns with proportions of expulsions and police involvement and then drop all the columns that are not needed.

```{r}
final_with_discipline <- combined_with_discipline %>% 
  mutate(Expulsion_Prop = Expulsions / District_Population, Police_Prop = Police_Involvement / District_Population) %>%
  select(-Expulsions, -Police_Involvement)
final_with_discipline
```

Going to load the data for bullying based on race.

```{r}
bully_race_data <- read_csv('cummalativerace.csv')
bully_race_data
```

Pivot the table to create rows out of the columns then rename the columns.

```{r}
bully_race_fixed <- bully_race_data %>% 
  distinct() %>% 
  pivot_wider(names_from = Category, values_from = Total)
bully_race_fixed
```

Combine the bullying based on race with the other table.

```{r}
class(bully_race_fixed$ID) = "character"
combined_with_race <- left_join(final_with_discipline, bully_race_fixed, by = 'ID')
combined_with_race
```
```{r}
sum(is.na(combined_with_race))
```
```{r}
final_with_race <- combined_with_race %>% 
  mutate(Race_Disc = Discplined_Race / District_Population, Race_Reports = Reported_Race / District_Population) %>%
  select(-Discplined_Race, -Reported_Race, -LEA, -'Lea State')
final_with_race
```

I will load the data for being bullied by gender.
```{r}
bully_gender_data <- read_csv('cummalativegender.csv')
bully_gender_data
```

Fix the datatable turning the categories into columns.
```{r}
bully_gender_fixed <- bully_gender_data %>% 
  distinct() %>% 
  pivot_wider(names_from = Category, values_from = Total)
bully_gender_fixed
```
Now I will join this with the other datatable.
```{r}
class(bully_gender_fixed$ID) = "character"
combined_with_gender <- left_join(final_with_race, bully_gender_fixed, by = 'ID')
combined_with_gender
```
```{r}
sum(is.na(combined_with_gender))
```
Now I will changed the columns to proportions and drop the excess.
```{r}
final_with_gender <- combined_with_gender %>% 
  mutate(Gender_Disc = Discplined_Gender / District_Population, Gender_Reports = Reported_Gender / District_Population) %>%
  select(-Discplined_Gender, -Reported_Gender, -LEA, -'Lea State')
final_with_gender
```

I will bring in the data on math and science courses that are offered.

```{r}
courses_data <- read_csv('cummalativescience.csv')
courses_data
```
Fixing the table by changing rows to columns.
```{r}
classes_fixed <- courses_data %>% 
  distinct() %>% 
  pivot_wider(names_from = Category, values_from = Total)
classes_fixed
```
Joining the courses with the other datatable.

```{r}
class(classes_fixed$ID) = "character"
combined_with_courses <- left_join(final_with_gender, classes_fixed, by = 'ID')
combined_with_courses
```

```{r}
sum(is.na(combined_with_courses))
```
Replacing NA values with the mean for the column since this data was not able to be retrieved from the system.
```{r}
combined_with_courses <-   select(combined_with_courses,-'LEA', -'Lea State')
combined_with_courses$Algebra1[is.na(combined_with_courses$Algebra1)]<-mean(combined_with_courses$Algebra1,na.rm=TRUE)
combined_with_courses$'Geometry'[is.na(combined_with_courses$'Geometry')]<-mean(combined_with_courses$'Geometry',na.rm=TRUE)
combined_with_courses$Algebra2[is.na(combined_with_courses$Algebra2)]<-mean(combined_with_courses$Algebra2,na.rm=TRUE)
combined_with_courses$'Adv_Math'[is.na(combined_with_courses$'Adv_Math')]<-mean(combined_with_courses$'Adv_Math',na.rm=TRUE)
combined_with_courses$'Calculus'[is.na(combined_with_courses$'Calculus')]<-mean(combined_with_courses$'Calculus',na.rm=TRUE)
combined_with_courses$'Biology'[is.na(combined_with_courses$'Biology')]<-mean(combined_with_courses$'Biology',na.rm=TRUE)
combined_with_courses$'Chemistry'[is.na(combined_with_courses$'Chemistry')]<-mean(combined_with_courses$'Chemistry',na.rm=TRUE)
combined_with_courses$'Physics'[is.na(combined_with_courses$'Physics')]<-mean(combined_with_courses$'Physics',na.rm=TRUE)
```

```{r}
sum(is.na(combined_with_courses))
```
Creating proportions and removing the extra columns.

```{r}
final_with_courses <- combined_with_courses %>% 
  mutate(Alg1 = Algebra1 / District_Population, Alg2 = Algebra2 / District_Population, Geo = Geometry / District_Population, AdvMath = Adv_Math / District_Population, Calc = Calculus / District_Population, Bio = Biology / District_Population, Chem = Chemistry / District_Population, Phys = Physics / District_Population) %>%
  select(-Algebra1, -Algebra2, -'Geometry', -Adv_Math, -Calculus, -Biology, -Physics, -Chemistry)
final_with_courses
```

Loading the data on students that passed Algebra.
```{r}
passed_data <- read_csv('mathperformance.csv')
passed_data
```
I will change the rows into columns to work with the data.
```{r}
passed_fixed <- passed_data %>% 
  distinct() %>% 
  pivot_wider(names_from = Category, values_from = Total)
passed_fixed
```

```{r}
sum(is.na(passed_fixed))
```
Turning the na into zero since there were no students that took the course.

```{r}
class(passed_fixed$Algebra_Early) = "double"
class(passed_fixed$Algebra_Early_Passed) = "double"
class(passed_fixed$Algebra_Late) = "double"
class(passed_fixed$Algebra_Late_Passed) = "double"
passed_completed <- replace(passed_fixed, is.na(passed_fixed), 0)
```
```{r}
sum(is.na(passed_completed))
```
```{r}
courses_proportion <- passed_completed %>%
  mutate(Early_Pass = Algebra_Early_Passed / Algebra_Early, Late_Pass = Algebra_Late_Passed / Algebra_Late)
courses_proportion <- replace(courses_proportion, is.na(courses_proportion), 0)
courses_proportion
```
Joining with the other data table.

```{r}
combined_with_passing <- left_join(final_with_courses, courses_proportion, by = 'ID')
combined_with_passing
```
Cleaning up the table by dropping extra columns.

```{r}
final_passing <- combined_with_passing %>%
  select(-Algebra_Early, -Algebra_Early_Passed, -Algebra_Late, -Algebra_Late_Passed)
final_passing
```
Goinng to load in the graduation rate data file.

```{r}
grad_data <- read_csv('graduationrate.csv')
grad_data
```
I am going to do an inner join with the other datatable to make sure that there is a grad rate for each of the districts.

```{r}
class(grad_data$ID) = "character"
combined_with_grad <- inner_join(final_passing, grad_data, by = 'ID')
combined_with_grad
```




Creating one last feature finding the proportion of students compared to the area population. This will be the final part for the datatable.


```{r}
final_datatable <- mutate(combined_with_grad, Student_Prop = District_Population / Area_Population)
final_datatable
```

Filter out outliers that do not make sense.

```{r}
final_table <- final_datatable %>%
  filter(Absent_Prop <= 1) %>%
  filter(Athletes_Prop <= 1) %>%
  filter(Takers_Proportion <= 1) %>%
  filter(Late_Pass <= 1)

final_table
```




Writing the datatable as a csv file now that it is complete.
```{r}
write.csv(x=final_table, file="ProjectDataTableNewData.csv")
